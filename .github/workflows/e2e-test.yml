name: E2E Visual Regression Tests

on:
  repository_dispatch:
    types: [backlog-push]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to test'
        required: false
        default: 'main'

jobs:
  e2e-test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
      deployments: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.branch || github.event.inputs.branch || github.ref_name || 'main' }}
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: |
          echo "Checking package.json and package-lock.json..."
          ls -la package.json package-lock.json || true
          echo "Running npm ci..."
          npm ci || {
            echo "npm ci failed, trying npm install..."
            npm install
          }

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Get branch name
        id: branch
        run: |
          BRANCH="${{ github.event.client_payload.branch || github.event.inputs.branch || github.ref_name || 'main' }}"
          echo "BRANCH=$BRANCH" >> $GITHUB_OUTPUT
          echo "Using branch: $BRANCH"

      - name: Read BASE_URL from config
        id: base-url
        run: |
          BASE_URL=$(jq -r '.baseUrl' config/base-url.json)
          echo "BASE_URL=$BASE_URL" >> $GITHUB_OUTPUT
          echo "Using BASE_URL: $BASE_URL"

      - name: Get baseline commit info
        id: baseline
        if: steps.branch.outputs.BRANCH != 'main'
        run: |
          # mainブランチの最新コミットを取得（ベースラインとして使用）
          BASELINE_COMMIT=$(git ls-remote origin main | cut -f1 | head -c 7 || echo "unknown")
          echo "BASELINE_COMMIT=$BASELINE_COMMIT" >> $GITHUB_OUTPUT
          echo "Baseline commit: $BASELINE_COMMIT"

      - name: Download baseline from artifacts (if available)
        if: steps.branch.outputs.BRANCH == 'main'
        uses: dawidd6/action-download-artifact@v3
        with:
          name: baseline-screenshots-main
          path: tests/
          if_no_artifact_found: ignore
        continue-on-error: true
        id: download-baseline-artifacts

      - name: Pull latest baseline metadata and screenshots
        if: steps.branch.outputs.BRANCH == 'main'
        run: |
          # testsディレクトリが存在することを確認
          mkdir -p tests
          
          # Artifactsから取得できたか確認
          if [ "${{ steps.download-baseline-artifacts.outcome }}" = "success" ]; then
            echo "Baseline retrieved from Artifacts"
          else
            echo "Baseline not found in Artifacts, trying to get from Git..."
            
            # Gitからbaselineを取得（フォールバック）
            echo "Fetching latest changes from origin/main..."
            git fetch origin main --depth=10 || echo "Fetch failed"
            
            # baselineメタデータを取得（最新のコミットから）
            if git show origin/main:tests/baseline-metadata.json > tests/baseline-metadata.json 2>/dev/null; then
              echo "Baseline metadata retrieved from origin/main"
            else
              echo "No baseline metadata found in latest commit, trying to find in recent commits..."
              # 最近のコミットを確認
              for commit in $(git log origin/main --oneline -10 --format="%H"); do
                if git show $commit:tests/baseline-metadata.json > tests/baseline-metadata.json 2>/dev/null; then
                  echo "Baseline metadata found in commit $commit"
                  break
                fi
              done
              # まだ見つからない場合はcheckoutを試す
              if [ ! -f "tests/baseline-metadata.json" ]; then
                git checkout origin/main -- tests/baseline-metadata.json 2>/dev/null || echo "Checkout also failed"
              fi
            fi
            
            # baselineスクリーンショットを取得
            echo "Checking for baseline screenshots in Git..."
            SNAPSHOTS_DIR="tests/visual-regression.spec.ts-snapshots"
            if git ls-tree -r origin/main --name-only | grep -q "tests.*snapshots.*\.png"; then
              echo "Baseline screenshots found in repository"
              # ディレクトリを作成
              mkdir -p "$SNAPSHOTS_DIR"
              # 個別のファイルを取得
              for png_file in $(git ls-tree -r origin/main --name-only | grep "tests.*snapshots.*\.png"); do
                git show "origin/main:$png_file" > "$png_file" 2>/dev/null && echo "Retrieved: $png_file" || echo "Failed to retrieve: $png_file"
              done
            else
              echo "No baseline screenshots found in repository"
              # リポジトリ内の画像ファイルを確認
              echo "Checking for any PNG files in tests directory:"
              git ls-tree -r origin/main --name-only | grep "tests.*\.png" | head -10 || echo "No PNG files found"
            fi
          fi
          
          # baselineメタデータの存在を確認
          if [ -f "tests/baseline-metadata.json" ]; then
            echo "Baseline metadata found:"
            cat tests/baseline-metadata.json
            echo ""
            echo "Baseline metadata file exists and is readable"
            ls -la tests/baseline-metadata.json
          else
            echo "No baseline metadata found (this will be the first run)"
          fi
          
          # baselineスクリーンショットの存在を確認
          echo "Checking for baseline screenshots in various locations..."
          SNAPSHOTS_DIR="tests/visual-regression.spec.ts-snapshots"
          if [ -d "$SNAPSHOTS_DIR" ] && [ "$(ls -A $SNAPSHOTS_DIR/*.png 2>/dev/null | wc -l)" -gt 0 ]; then
            echo "Baseline screenshots found in $SNAPSHOTS_DIR:"
            ls -la "$SNAPSHOTS_DIR"/*.png | head -10
          elif find tests -name "*.png" -path "*/snapshots/*" 2>/dev/null | grep -q .; then
            echo "Baseline screenshots found:"
            find tests -name "*.png" -path "*/snapshots/*" | head -10
          else
            echo "No baseline screenshots found (this will be the first run)"
            echo "Checking for PNG files in tests directory:"
            find tests -type f -name "*.png" 2>/dev/null | head -10 || echo "No PNG files found"
          fi
          
          echo "Current directory: $(pwd)"
          echo "Tests directory structure:"
          ls -la tests/ 2>/dev/null || echo "Tests directory does not exist"
          if [ -d "tests" ]; then
            echo "Recursive listing of tests directory:"
            find tests -type f 2>/dev/null | head -20 || echo "No files found"
          fi
          
      - name: Save baseline metadata before test (for comparison)
        if: steps.branch.outputs.BRANCH == 'main'
        run: |
          # テスト実行前にbaselineメタデータをバックアップ（比較用）
          if [ -f "tests/baseline-metadata.json" ]; then
            cp tests/baseline-metadata.json tests/baseline-metadata-before-test.json
            echo "Baseline metadata saved for comparison:"
            cat tests/baseline-metadata-before-test.json
          else
            echo "No baseline metadata found (first run)"
          fi

      - name: Run Visual Regression Tests
        id: test-run
        env:
          BASE_URL: ${{ steps.base-url.outputs.BASE_URL }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          BASELINE_COMMIT: ${{ steps.baseline.outputs.BASELINE_COMMIT }}
          GITHUB_SHA: ${{ github.sha }}
        run: |
          # 前回のテスト結果をbaselineとして比較（差分があっても記録する）
          echo "Running visual regression tests against baseline from previous run"
          
          # バックアップしたbaselineメタデータを復元（テスト実行時に使用）
          if [ -f "tests/baseline-metadata-before-test.json" ]; then
            cp tests/baseline-metadata-before-test.json tests/baseline-metadata.json
            echo "Baseline metadata restored for test execution:"
            cat tests/baseline-metadata.json
          fi
          
          # baselineメタデータの存在を確認
          if [ -f "tests/baseline-metadata.json" ]; then
            echo "Baseline metadata found:"
            cat tests/baseline-metadata.json
            echo ""
            echo "Baseline metadata file path: $(pwd)/tests/baseline-metadata.json"
            echo "File exists check: $(test -f tests/baseline-metadata.json && echo 'YES' || echo 'NO')"
          else
            echo "No baseline metadata found (first run)"
            echo "Current directory: $(pwd)"
            echo "Tests directory contents:"
            ls -la tests/ 2>/dev/null || echo "Tests directory does not exist"
          fi
          
          # baselineスクリーンショットの存在を確認
          echo "Checking for baseline screenshots..."
          find tests -name "*.png" -path "*/snapshots/*" 2>/dev/null | head -10 || echo "No baseline screenshots found"
          
          npx playwright test --grep "Visual Regression" || true
          # テスト結果に関わらず続行（差分があってもbaselineを更新する方針）

      - name: Update baseline screenshots
        if: always() && steps.branch.outputs.BRANCH == 'main'
        env:
          BASE_URL: ${{ steps.base-url.outputs.BASE_URL }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
          BASELINE_COMMIT: ${{ steps.baseline.outputs.BASELINE_COMMIT }}
        run: |
          # テスト結果に関わらず、常に新しいスクリーンショットをbaselineとして更新
          echo "Updating baseline screenshots for next run (regardless of test result)..."
          npx playwright test --grep "Visual Regression" --update-snapshots
          
          # baselineメタデータを作成（次回のテストでbaseline情報を表示するため）
          BASELINE_TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
          BASELINE_COMMIT_SHORT=$(echo "${{ github.sha }}" | head -c 7)
          mkdir -p tests
          cat > tests/baseline-metadata.json <<EOF
          {
            "commit": "${BASELINE_COMMIT_SHORT}",
            "timestamp": "${BASELINE_TIMESTAMP}",
            "run_id": "${{ github.run_id }}"
          }
          EOF
          
          # Playwrightのsnapshotsディレクトリ構造を確認
          SNAPSHOTS_DIR="tests/visual-regression.spec.ts-snapshots"
          echo "Checking for baseline screenshots in $SNAPSHOTS_DIR..."
          
          # baselineスクリーンショットの存在を確認
          BASELINE_FILES_EXIST=false
          if [ -d "$SNAPSHOTS_DIR" ] && [ "$(ls -A $SNAPSHOTS_DIR/*.png 2>/dev/null | wc -l)" -gt 0 ]; then
            echo "Baseline screenshots found in $SNAPSHOTS_DIR:"
            ls -la "$SNAPSHOTS_DIR"/*.png
            BASELINE_FILES_EXIST=true
          else
            echo "No baseline screenshots found in $SNAPSHOTS_DIR"
            echo "Checking other possible locations..."
            if find tests -name "*.png" -path "*/snapshots/*" 2>/dev/null | grep -q .; then
              echo "Baseline screenshots found in other locations:"
              find tests -name "*.png" -path "*/snapshots/*" | head -10
              BASELINE_FILES_EXIST=true
            else
              echo "WARNING: No baseline screenshots found after update!"
            fi
          fi
          
          # baselineメタデータの存在を確認
          if [ ! -f "tests/baseline-metadata.json" ]; then
            echo "ERROR: baseline-metadata.json was not created!"
            exit 1
          fi
          
          echo "Baseline metadata content:"
          cat tests/baseline-metadata.json
          
          # 更新されたbaselineスクリーンショットとメタデータをGitにコミット
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          
          # baselineスクリーンショットとメタデータを確実に追加
          if [ "$BASELINE_FILES_EXIST" = "true" ]; then
            # 具体的なディレクトリパスを指定
            if [ -d "$SNAPSHOTS_DIR" ]; then
              git add "$SNAPSHOTS_DIR"/*.png 2>/dev/null || {
                echo "Failed to add screenshots with pattern, trying find command..."
                find tests -name "*.png" -path "*/snapshots/*" -exec git add {} \; 2>/dev/null || echo "Failed to add screenshots"
              }
            else
              # 他の場所にある場合
              find tests -name "*.png" -path "*/snapshots/*" -exec git add {} \; 2>/dev/null || echo "Failed to add screenshots"
            fi
          fi
          
          # メタデータを追加
          git add tests/baseline-metadata.json || {
            echo "ERROR: Failed to add baseline-metadata.json"
            exit 1
          }
          
          # ステージングされた変更を確認
          echo "Staged changes:"
          git status --short || echo "No changes to stage"
          
          if git diff --staged --quiet; then
            echo "No baseline screenshot or metadata changes to commit"
          else
            echo "Committing updated baseline screenshots and metadata..."
            git commit -m "Update baseline screenshots from test run ${{ github.run_id }} [skip ci]" || {
              echo "ERROR: Commit failed"
              exit 1
            }
            
            # pushをリトライ（最大3回）
            PUSH_RETRIES=3
            PUSH_SUCCESS=false
            for i in $(seq 1 $PUSH_RETRIES); do
              if git push origin main; then
                echo "Baseline metadata committed and pushed successfully"
                PUSH_SUCCESS=true
                break
              else
                echo "Push attempt $i failed, retrying..."
                sleep 2
              fi
            done
            
            if [ "$PUSH_SUCCESS" = "false" ]; then
              echo "ERROR: Failed to push baseline after $PUSH_RETRIES attempts"
              exit 1
            fi
          fi

      - name: Upload baseline to artifacts
        if: always() && steps.branch.outputs.BRANCH == 'main'
        uses: actions/upload-artifact@v4
        with:
          name: baseline-screenshots-main
          path: |
            tests/visual-regression.spec.ts-snapshots/
            tests/baseline-metadata.json
          retention-days: 90
          if-no-files-found: ignore

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ steps.branch.outputs.BRANCH }}
          path: |
            playwright-report/
            test-results/
            tests/**/*-snapshots/**/*.png
            tests/baseline-metadata.json
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload test videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-videos-${{ steps.branch.outputs.BRANCH }}
          path: test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Set test result status
        id: test-result
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=E2Eテストが成功しました" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=E2Eテストが失敗しました" >> $GITHUB_OUTPUT
          fi

      # Cloudflare Pages関連のステップ
      - name: Prepare report directory for Cloudflare Pages
        if: always()
        run: |
          BRANCH="${{ steps.branch.outputs.BRANCH }}"
          TIMESTAMP=$(date -u +%Y%m%d_%H%M%S)
          
          mkdir -p cloudflare-pages-report
          if [ -d "playwright-report" ] && [ "$(ls -A playwright-report)" ]; then
            cp -r playwright-report/* cloudflare-pages-report/
          else
            echo "No test report found, creating placeholder"
            echo "<html><body><h1>Test Report</h1><p>No test results available</p></body></html>" > cloudflare-pages-report/index.html
          fi
          
          # テスト情報を記録
          echo "{\"branch\": \"$BRANCH\", \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"run_id\": \"${{ github.run_id }}\", \"status\": \"${{ steps.test-result.outputs.status }}\"}" > cloudflare-pages-report/metadata.json

      - name: Deploy to Cloudflare Pages
        if: always()
        id: deployment
        uses: cloudflare/pages-action@v1
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          projectName: ${{ secrets.CLOUDFLARE_PAGES_PROJECT_NAME }}
          directory: cloudflare-pages-report/
          gitHubToken: ${{ secrets.GITHUB_TOKEN }}

      - name: Send Slack notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Slack Webhook URLが設定されていない場合はスキップ
          if [ -z "$SLACK_WEBHOOK_URL" ] || [ "$SLACK_WEBHOOK_URL" = "" ]; then
            echo "SLACK_WEBHOOK_URL is not set, skipping Slack notification"
            exit 0
          fi
          
          BRANCH="${{ steps.branch.outputs.BRANCH }}"
          STATUS="${{ steps.test-result.outputs.status }}"
          MESSAGE="${{ steps.test-result.outputs.message }}"
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          if [ "$STATUS" = "success" ]; then
            COLOR="good"
            EMOJI="✅"
            STATUS_TEXT="テスト成功"
          else
            COLOR="danger"
            EMOJI="❌"
            STATUS_TEXT="テスト失敗"
          fi
          
          # Cloudflare Pages URLを追加
          if [ -n "${{ steps.deployment.outputs.url }}" ]; then
            PAGES_URL="${{ steps.deployment.outputs.url }}"
          else
            PAGES_URL="https://202512visual-test-result.pages.dev"
          fi
          PAGES_FIELD=",
                {\"title\": \"テスト結果レポート\", \"value\": \"<${PAGES_URL}|Cloudflare Pagesで確認>\", \"short\": false}"
          
          PAYLOAD=$(cat <<EOF
          {
            "text": "${EMOJI} E2E Visual Regression Test結果通知",
            "attachments": [{
              "color": "${COLOR}",
              "fields": [
                {"title": "ブランチ", "value": "${BRANCH}", "short": true},
                {"title": "ステータス", "value": "${STATUS_TEXT}", "short": true},
                {"title": "メッセージ", "value": "${MESSAGE}", "short": false},
                {"title": "ワークフロー", "value": "<${WORKFLOW_URL}|詳細を確認>", "short": false}${PAGES_FIELD}
              ],
              "footer": "GitHub Actions",
              "ts": $(date +%s)
            }]
          }
          EOF
          )
          
          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL"
        continue-on-error: true

