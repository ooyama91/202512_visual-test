name: E2E Visual Regression Tests

on:
  repository_dispatch:
    types: [backlog-push]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Branch to test'
        required: true
        default: 'develop'

jobs:
  e2e-test:
    timeout-minutes: 60
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pages: write
      id-token: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.client_payload.branch || github.event.inputs.branch || github.ref_name || 'main' }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
        continue-on-error: true

      - name: Install dependencies
        run: |
          echo "Checking package.json and package-lock.json..."
          ls -la package.json package-lock.json || true
          echo "Running npm ci..."
          npm ci || {
            echo "npm ci failed, trying npm install..."
            npm install
          }

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Get branch name
        id: branch
        run: |
          BRANCH="${{ github.event.client_payload.branch || github.event.inputs.branch || github.ref_name || 'main' }}"
          echo "BRANCH=$BRANCH" >> $GITHUB_OUTPUT
          echo "Using branch: $BRANCH"

      - name: Read BASE_URL from config
        id: base-url
        run: |
          BASE_URL=$(jq -r '.baseUrl' config/base-url.json)
          echo "BASE_URL=$BASE_URL" >> $GITHUB_OUTPUT
          echo "Using BASE_URL: $BASE_URL"

      - name: Run Visual Regression Tests
        env:
          BASE_URL: ${{ steps.base-url.outputs.BASE_URL }}
        run: |
          # ベースラインスクリーンショットを取得（mainブランチの場合のみ更新）
          if [ "${{ steps.branch.outputs.BRANCH }}" = "main" ]; then
            echo "Updating baseline screenshots for main branch"
            npx playwright test --grep "Visual Regression" --update-snapshots
          else
            echo "Running visual regression tests against baseline"
            npx playwright test --grep "Visual Regression"
          fi

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report-${{ steps.branch.outputs.BRANCH }}
          path: |
            playwright-report/
            test-results/
          retention-days: 30
          if-no-files-found: ignore

      - name: Upload test videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-videos-${{ steps.branch.outputs.BRANCH }}
          path: test-results/
          retention-days: 7
          if-no-files-found: ignore

      - name: Set test result status
        id: test-result
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "status=success" >> $GITHUB_OUTPUT
            echo "message=E2Eテストが成功しました" >> $GITHUB_OUTPUT
          else
            echo "status=failure" >> $GITHUB_OUTPUT
            echo "message=E2Eテストが失敗しました" >> $GITHUB_OUTPUT
          fi

      # GitHub Pages関連のステップ（プライベートリポジトリの無料プランでは利用不可のためスキップ）
      # 将来的にGitHub Pagesを使用する場合は、以下のコメントを外して有効化してください
      # - name: Prepare report directory for GitHub Pages
      #   if: always()
      #   run: |
      #     BRANCH="${{ steps.branch.outputs.BRANCH }}"
      #     TIMESTAMP=$(date -u +%Y%m%d_%H%M%S)
      #     
      #     mkdir -p gh-pages-report
      #     if [ -d "playwright-report" ] && [ "$(ls -A playwright-report)" ]; then
      #       cp -r playwright-report/* gh-pages-report/
      #     else
      #       echo "No test report found, creating placeholder"
      #       echo "<html><body><h1>Test Report</h1><p>No test results available</p></body></html>" > gh-pages-report/index.html
      #     fi
      #     
      #     # テスト情報を記録
      #     echo "{\"branch\": \"$BRANCH\", \"timestamp\": \"$(date -u +%Y-%m-%dT%H:%M:%SZ)\", \"run_id\": \"${{ github.run_id }}\", \"status\": \"${{ steps.test-result.outputs.status }}\"}" > gh-pages-report/metadata.json
      # 
      # - name: Setup Pages
      #   if: always()
      #   uses: actions/configure-pages@v4
      # 
      # - name: Upload artifact for GitHub Pages
      #   if: always()
      #   uses: actions/upload-pages-artifact@v3
      #   with:
      #     path: gh-pages-report/
      # 
      # - name: Deploy to GitHub Pages
      #   if: always()
      #   id: deployment
      #   uses: actions/deploy-pages@v4

      - name: Send Slack notification
        if: always()
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          # Slack Webhook URLが設定されていない場合はスキップ
          if [ -z "$SLACK_WEBHOOK_URL" ] || [ "$SLACK_WEBHOOK_URL" = "" ]; then
            echo "SLACK_WEBHOOK_URL is not set, skipping Slack notification"
            exit 0
          fi
          
          BRANCH="${{ steps.branch.outputs.BRANCH }}"
          STATUS="${{ steps.test-result.outputs.status }}"
          MESSAGE="${{ steps.test-result.outputs.message }}"
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          
          if [ "$STATUS" = "success" ]; then
            COLOR="good"
            EMOJI="✅"
            STATUS_TEXT="テスト成功"
          else
            COLOR="danger"
            EMOJI="❌"
            STATUS_TEXT="テスト失敗"
          fi
          
          # GitHub Pages URLは現在使用していないため、フィールドは追加しない
          PAGES_FIELD=""
          
          PAYLOAD=$(cat <<EOF
          {
            "text": "${EMOJI} E2E Visual Regression Test結果通知",
            "attachments": [{
              "color": "${COLOR}",
              "fields": [
                {"title": "ブランチ", "value": "${BRANCH}", "short": true},
                {"title": "ステータス", "value": "${STATUS_TEXT}", "short": true},
                {"title": "メッセージ", "value": "${MESSAGE}", "short": false},
                {"title": "ワークフロー", "value": "<${WORKFLOW_URL}|詳細を確認>", "short": false}${PAGES_FIELD}
              ],
              "footer": "GitHub Actions",
              "ts": $(date +%s)
            }]
          }
          EOF
          )
          
          curl -X POST -H 'Content-type: application/json' \
            --data "$PAYLOAD" \
            "$SLACK_WEBHOOK_URL"
        continue-on-error: true

